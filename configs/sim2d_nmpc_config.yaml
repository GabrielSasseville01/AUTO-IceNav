#############################################################################
# Config for ship ice navigation with Neural MPC planner in 2D simulation  #
#############################################################################
# This config is based on sim2d_diffusion_config.yaml but uses the neural MPC
# planner instead. The neural MPC uses a trained neural network to predict
# continuous paths from discrete A* plans, with optional gradient-based optimization.

### GLOBAL PARAMS
output_dir: null            # root directory for storing all experiment output files
comments: 'Neural MPC planner experiment'
map_shape:
  - 600                    # length of ice channel in metres
  - 600                     # width of ice channel in metres
map_file: "data/MEDEA_fram_20100629.pkl"
plot:
  y_axis_limit: 600         # limit in metres for the y-axis of the plot
  show: false              # true will show planner plots (set false for neural MPC)
seed: 1

### PLANNER PARAMS
horizon: 100.               # distance in metres for the horizon distance
save_paths: false           # if true save planned paths to disk
path_step_size: 0.2        # spacing in meters between points on planned path

# Use Neural MPC planner
planner: 'neural_mpc'       # Neural model predictive control planner

### NEURAL MPC SPECIFIC PARAMS
# These parameters control the neural MPC behavior
# Now learns spline parameters instead of full trajectories
neural_mpc:
  model_path: 'neural_mpc_models/best_model.pth'  # Path to trained model
  use_gradient_optimization: true  # Use gradient-based optimization with costmap
  optimization_steps: 10    # Number of gradient steps for optimization
  learning_rate: 0.01       # Learning rate for gradient optimization
  horizon: 25              # Planning horizon (number of steps)
  max_discrete_nodes: 50    # Maximum number of discrete nodes
  num_spline_control_points: 15  # Number of B-spline control points to predict
  discrete_densify_step_size: 5.0  # Interpolate discrete plan to have points every N meters
  min_discrete_points: 20   # Minimum number of discrete points
  max_discrete_points: 100  # Maximum number of discrete points

# A* parameters (used for initial discrete path that gets densified)
a_star:
  weight: 1                 # static weighting for weighed A* f(n) = g(n) + w * h(n) where weight > 1
costmap:
  scale: 0.5                # scale factor of the costmap which gives a resolution of 1/scale x 1/scale metres
  collision_cost_weight:
   0.5               # multiplier for the collision cost (0.00000048)
  obs_cost_buffer_factor:
   0.15                     # factor to scale up the polygons when generating costmap
  ice_resistance_weight: 1  # power to raise the ice concentration term to
  sic_kernel: [51, 51]      # the size of the kernel for computing sea ice concentration map
  boundary_margin: 2        # margin in metres on either side of the ice channel to set as boundary
prim:
  prim_name: 'PRIM_8H_4'    # name of the set of primitives to use
  scale: 15                 # scale factor of the primitives
  step_size: 0.5            # step size for sampling points on the path

# Optimization step (disabled for neural MPC since it handles optimization)
optim:
  plot: false
  debug: false
  anim: false
  body_point_params:
    spacing: 3
    margin: 0
    weights: null
    plot: false
  wp_spacing: 2
  goal_margin: 0.1
  horizon: 25
  smooth_control_weight: 50000
  p_opts:
    ipopt.print_level: 0
    ipopt.sb: 'yes'
    print_time: 0
  s_opts:
    print_level: 0
    max_cpu_time: 4.0

### SIMULATION PARAMS
sim:
  t_max: 50000              # max number of iterations in simulation loop
  steps: 4                  # number of simulation steps per iteration
  planner_timeout: 5.0      # timeout in seconds for polling of planner updates
anim:
  save: false
  fps: 50
  show: true
  plot_steps: 5
  inf_stream: true
  move_yaxis_threshold: 10
goal_offset: 30

### SHIP MODEL AND CONTROLLER PARAMS
ship:
  spawn_padding: 50
  goal_pos: [600, 600]
  start_pos: [50.0, 0.0, 1.5707963267948966]
  mass: 6000000
  padding: 0.0
  vertices: [[43.1, 0.0],
             [35.4, 4.0],
             [27.5, 6.5],
             [11.6, 9.0],
             [-33.1, 9.0],
             [-33.1, -9.0],
             [11.6, -9.0],
             [27.5, -6.5],
             [35.4, -4.0]]
sim_dynamics:
  vessel_model: 'AISship'
  dt: 0.02
  target_speed: 2.0
  max_acceleration: 0.04
  track_time: 30

