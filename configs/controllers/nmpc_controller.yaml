#############################################################################
# Config for ship ice navigation with DIFFUSION planner in 2D simulation    #
#############################################################################
# This config is based on sim2d_config.yaml but uses the diffusion planner
# instead of the lattice planner. The diffusion planner combines A* discrete
# planning with model-based diffusion optimization for smoother trajectories.

### GLOBAL PARAMS
analysis_save_path: "trajectories/nmpc"
output_dir: null            # root directory for storing all experiment output files
map_shape:
  - 600                    # length of ice channel in metres
  - 600                     # width of ice channel in metres
map_file: "data/MEDEA_fram_20100629.pkl"
plot:
  y_axis_limit: 600         # limit in metres for the y-axis of the plot
  show: true               # true will show planner plots
seed: 1

### PLANNER PARAMS
horizon: 500.               # distance in metres for the horizon distance
save_paths: false           # if true save planned paths to disk
path_step_size: 0.02        # spacing in meters between points on planned path

# CHANGED: Use diffusion planner instead of lattice
planner: 'neural_mpc'        # path planner: 'skeleton', 'straight', 'lattice', or 'diffusion'
                            # 'diffusion' combines A* discrete planning with diffusion optimization

neural_mpc:
  # Path to trained Neural MPC model weights
  nmpc_model_weights: 'data/nmpc_baseline.pth'
  
  # Planning horizon (number of points in predicted path)
  horizon: 200
  
  # Gradient-based optimization settings
  use_gradient_optimization: true      # Enable gradient optimization with costmap
  optimization_steps: 10               # Number of gradient descent steps
  learning_rate: 0.01                  # Learning rate for gradient optimization
  
  # Neural network architecture parameters
  max_discrete_nodes: 50               # Maximum discrete A* waypoints to process
  num_spline_control_points: 15        # Number of spline control points to predict
  
  # Critic network settings (optional, for learned value estimation)
  use_critic: false                    # Whether to use a learned critic for path evaluation
  critic_path: null                    # Path to trained critic model (if use_critic is true)
  
  # Discrete plan densification settings
  discrete_densify_step_size: 5.0      # Step size (meters) for densifying discrete A* plan
  min_discrete_points: 20              # Minimum points after densification
  max_discrete_points: 100             # Maximum points after densification


# A* parameters (used for initial discrete path)
a_star:
  weight: 1                 # static weighting for weighed A* f(n) = g(n) + w * h(n) where weight > 1
costmap:
  scale: 0.5                # scale factor of the costmap which gives a resolution of 1/scale x 1/scale metres
  collision_cost_weight:
   0.5               # multiplier for the collision cost (0.00000048)
  obs_cost_buffer_factor:
   0.15                     # factor to scale up the polygons when generating costmap
  ice_resistance_weight: 1  # power to raise the ice concentration term to
  sic_kernel: [51, 51]      # the size of the kernel for computing sea ice concentration map
  boundary_margin: 2        # margin in metres on either side of the ice channel to set as boundary
  ridge_costmap_file: "data/ridge_costmap_MEDEA_fram_20100629_scale05_fixed.pkl"  # Ridge density costmap for path planning
  ridge_cost_weight: 1.0    # Weight for ridge avoidance (higher = avoid ridges more strongly)
  polygon_file: "data/ice_floes_MEDEA_fram_20100629.pkl"  # Polygon file for aligning ridge density with ice floes
prim:
  prim_name: 'PRIM_8H_4'    # name of the set of primitives to use
  scale: 15                 # scale factor of the primitives
  step_size: 0.5            # step size for sampling points on the path

# Optimization step (can be disabled for diffusion planner since diffusion handles optimization)
optim:
  plot: false
  debug: false
  anim: true
  body_point_params:
    spacing: 3
    margin: 0
    weights: null
    plot: false
  wp_spacing: 2
  goal_margin: 0.1
  horizon: 500.
  smooth_control_weight: 50000
  p_opts:
    ipopt.print_level: 0
    ipopt.sb: 'yes'
    print_time: 0
  s_opts:
    print_level: 0
    max_cpu_time: 4.0

### SIMULATION PARAMS
sim:
  t_max: 50000              # max number of iterations in simulation loop
  steps: 1                  # number of simulation steps per iteration
  planner_timeout: 5.0      # timeout in seconds for polling of planner updates
anim:
  save: false               # if true, save animation videos to MP4 files (sim.mp4 and costmap.mp4)
  fps: 50                  # frames per second for saved animations
  show: true               # if true, show live animation (cannot show and save at the same time)
  plot_steps: 5            # steps between plot updates
  inf_stream: true         # if true, animation view moves with ship
  move_yaxis_threshold: 10 # distance traveled before y-axis moves
goal_offset: 30

### SHIP MODEL AND CONTROLLER PARAMS
ship:
  spawn_padding: 50
  goal_pos: [600, 600]
  start_pos: [50.0, 0.0, 1.5707963267948966]
  mass: 6000000
  padding: 0.0
  vertices: [[43.1, 0.0],
             [35.4, 4.0],
             [27.5, 6.5],
             [11.6, 9.0],
             [-33.1, 9.0],
             [-33.1, -9.0],
             [11.6, -9.0],
             [27.5, -6.5],
             [35.4, -4.0]]
sim_dynamics:
  vessel_model: 'AISship'
  dt: 0.05
  target_speed: 2.0
  max_acceleration: 0.04
  track_time: 30
